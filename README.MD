HP Nanoprocessor reverse-engineering
====================================

Overview
--------

This repository documents my reverse-engineering of the HP Nanoprocessor masks.

It all started with 2 articles on Ken Shirriff's site ([1](http://www.righto.com/2020/09/inside-hp-nanoprocessor-high-speed.html) and [2](http://www.righto.com/2020/09/hp-nanoprocessor-part-ii-reverse.html)) where he analyzed the release of the original masks by Larry Bower, one of the designers of Nanoprocessor.

I always toyed with the idea of reverse engineering a chip and this release provided the right opportunity as I know the Nanoprocessor very well (I wrote the emulation on MAME) and the masks are a lot easier to understand than, for example, microscope pictures of the die.

As it turned out, Nanoprocessor was very easy to understand because of the straightforward approach the designers took for most of the aspects of the chip and the high quality of the mask scans.

My approach
-----------

1. I converted the PSD scan of the masks to a single Inkscape file. I stacked the masks in the right order as layers and I set the layer transparency to something that allowed me to see through the whole stack.

2. I added the pad names

3. I added a layer on top of everything for annotations. I started numbering transistors there in various functional blocks.

4. Using KiCad, I traced a rough schematic of functional blocks to understand how they worked. In the process I identified most major internal signals (such as data bus, clock phases, etc.).

5. Then, I wrote a polished and hierarchical KiCad schematic that it's the one you can see here.

Interesting things I found
--------------------------

- Distribution of clock phases inside the NP relies on carefully planned propagation delays. There are a few tricks employed by the designers to control the delay: bigger or smaller transistors, the same signal generated by longer or shorter chain of gates, etc.

- Manual specifies that NP has a "quasi-static" architecture: clock can be stopped indefinitely but it must stop in the low state as the high state has a maximum duration. If this is exceeded things can go wrong in various ways inside the chip. The most evident problem I see is the "re-circulation" of accumulator updates, i.e. the accumulator is updated multiple times during the execution of a single instruction.

- The "core" of Nanoprocessor (registers, accumulator and comparator) is surrounded by the instruction decoders. Here the direct and complemented output of instruction register is fed to an array of 123 NOR gates together with various clock signals. I called the output of the NORs "MT0..122" (MT is for maxterm) and I tabulated them outside of the schematic for simplicity's sake.

Files
-----

- `README.MD`: this file.

- `maxterms.html`: list of maxterms and their relationship to opcodes.

- `schematics`: KiCAD schematic files of Nanoprocessor.

- `nanoprocessor.pdf`: PDF print of schematics.

Organization of schematics
--------------------------

In organizing the schematic I tried to replicate through hierarchy the same "copy-paste" approach that the original designers used. It's clear that many of the "regular" blocks of the chip (registers, bits of accumulator and PA, etc.) are formed by geometrically repeating the shape of a basic block multiple times. I used the same approach in the schematic: the basic block is in sub-sheet that's instantiated multiple times.

In translating networks of transistors to gates, I included the output pull-up resistor/transistor in the gate. So, an inverter in the schematic is formed by two transistors in the chip, a n-input input NOR gates is formed by n+1 transistors and so on.

Most of the times, the output pull-up is tied to VDD. Sometimes a pull-up is connected to VGG: in this case I added a plus sign next to the output.

Pins have a name of the form `PIN_name` and they all are on the main sheet.

Main signals
------------

- `clk`: Main clock signals from outside

- `ph1`, `ph3`, `fetch`: derived clock phases

- `reset`: reset signal

- `intack`: interrupt acknowledge

- `I[0..7]`: instruction register content

- `Ib[0..7]`: internal data bus

- `skip`: enables/disables forward jump in skip instructions

Acknowledgments
---------------

- Larry Bower for publishing the original masks of the NP

- The people at CPU shack for cleaning and scanning them

- All the people behind the amazing KiCAD

- Last but definitely not least, Ken Shirriff for talking about the NP in his always entertaining blog.

License
-------

CC-BY-SA
